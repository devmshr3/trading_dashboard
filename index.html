<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>India Markets Dashboard</title>
    
    <!-- Tailwind CSS for modern styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Icons Library (FIXED) -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>

    <style>
        /* CSS Variables for Theming */
        :root {
            --bg-color: #131722;
            --card-bg-color: #1E222D;
            --text-color: #D1D4DC;
            --text-color-strong: #FFFFFF;
            --border-color: #2A2E39;
            --label-color: #787B86;
            --section-border: #363A45;
        }

        .light-mode {
            --bg-color: #F0F3F8;
            --card-bg-color: #FFFFFF;
            --text-color: #4A5568;
            --text-color-strong: #1A202C;
            --border-color: #E2E8F0;
            --label-color: #718096;
            --section-border: #CBD5E0;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
        }

        h1, h2 {
            color: var(--text-color-strong);
        }

        .market-card {
            background-color: var(--card-bg-color);
            border: 1px solid var(--border-color);
            border-radius: 0.75rem;
            padding: 1.5rem;
            transition: all 0.2s ease-in-out;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .market-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        .text-positive { color: #26A69A; }
        .text-negative { color: #EF5350; }
        .label-text { color: var(--label-color); font-size: 0.8rem; }
        
        .loader {
            width: 24px; height: 24px; border: 3px solid var(--label-color);
            border-bottom-color: transparent; border-radius: 50%;
            display: inline-block; box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }

        @keyframes rotation {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .gemini-button {
            background-image: linear-gradient(to right, #4f46e5, #818cf8);
            color: white; font-weight: 600; padding: 0.75rem 1.5rem;
            border-radius: 0.5rem; border: none; cursor: pointer;
            transition: all 0.3s ease; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .gemini-button:hover { transform: translateY(-2px); box-shadow: 0 7px 10px rgba(0,0,0,0.15); }
        .gemini-button:disabled { background-image: none; background-color: #4B5563; cursor: not-allowed; opacity: 0.7; }

        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.7); display: flex; align-items: center;
            justify-content: center; z-index: 1000; opacity: 0;
            visibility: hidden; transition: opacity 0.3s, visibility 0.3s;
        }
        .modal-overlay.visible { opacity: 1; visibility: visible; }
        .modal-content {
            background-color: var(--card-bg-color); padding: 2rem; border-radius: 0.75rem;
            width: 90%; max-width: 600px; max-height: 80vh;
            overflow-y: auto; transform: scale(0.95); transition: transform 0.3s;
        }
        .modal-overlay.visible .modal-content { transform: scale(1); }

        .theme-toggle-button {
            background-color: var(--card-bg-color);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            width: 40px; height: 40px;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: all 0.3s ease;
        }
        .theme-toggle-button:hover {
            background-color: var(--border-color);
        }
    </style>
</head>
<body class="antialiased">

    <!-- Main Container -->
    <div class="container mx-auto p-4 md:p-6 lg:p-8">

        <!-- Header -->
        <header class="text-center mb-4 relative">
            <h1 class="text-3xl md:text-4xl font-bold">Quantivue Dashboard</h1>
            <p class="text-sm mt-2 label-text">Quantivue is a real-time trading dashboard for Indian and global market data, featuring simulated updates for Global indices, Gold, Crude Oil, and interest rates.</p>
             <!-- Theme Toggle Button -->
            <div class="absolute top-0 right-0">
                <button id="theme-toggle" class="theme-toggle-button">
                    <i data-lucide="sun" class="light-icon"></i>
                    <i data-lucide="moon" class="dark-icon hidden"></i>
                </button>
            </div>
        </header>

        <!-- TradingView Ticker Widget -->
        <div class="tradingview-widget-container mb-8">
            <div class="tradingview-widget-container__widget"></div>
            <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-ticker-tape.js" async>
            {
                "symbols": [
                    { "description": "NIFTY 50", "proName": "NSE:NIFTY" },
                    { "description": "SENSEX", "proName": "BSE:SENSEX" },
                    { "description": "DOW JONES", "proName": "CURRENCYCOM:US30" },
                    { "description": "S&P 500", "proName": "SP:SPX" },
                    { "description": "NIKKEI 225", "proName": "CURRENCYCOM:JP225" },
                    { "description": "HANG SENG", "proName": "CURRENCYCOM:HK50" },
                    { "description": "FTSE 100", "proName": "CURRENCYCOM:UK100" },
                    { "description": "BRENT CRUDE", "proName": "TVC:UKOIL" },
                    { "description": "GOLD", "proName": "OANDA:XAUUSD" }
                ],
                "showSymbolLogo": true,
                "colorTheme": "dark",
                "isTransparent": false,
                "displayMode": "adaptive",
                "locale": "in"
            }
            </script>
        </div>

        <!-- Dashboard Grid -->
        <main>
            <!-- FII/DII Data -->
                <div id="fii-dii-data" class="lg:col-span-2 market-card"></div>
            </section>

            <!-- Section: Indian Indices -->
            <section class="mb-8">
                <h2 class="text-2xl font-semibold mb-4 border-l-4 border-blue-500 pl-3">Indian Indices</h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6">
                    <div id="nifty-50" class="market-card"></div>
                    <div id="sensex" class="market-card"></div>
                    <div id="gift-nifty" class="market-card"></div>
                    <div id="india-vix" class="market-card"></div>
                </div>
            </section>

            <!-- Section: Global Markets -->
            <section class="mb-8">
                <h2 class="text-2xl font-semibold mb-4 border-l-4 border-green-500 pl-3">Global Markets</h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6">
                    <div id="sp-500" class="market-card"></div>
                    <div id="us-futures" class="market-card"></div>
                    <div id="dow-jones" class="market-card"></div>
                    <div id="ftse-100" class="market-card"></div>
                    <div id="nikkei-225" class="market-card"></div>
                    <div id="hang-seng" class="market-card"></div>
                </div>
            </section>

            <!-- Section: Commodities -->
            <section class="mb-8">
                <h2 class="text-2xl font-semibold mb-4 border-l-4 border-yellow-500 pl-3">Commodities</h2>
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 md:gap-6">
                    <div id="brent-oil" class="market-card"></div>
                    <div id="wti-oil" class="market-card"></div>
                    <div id="gold" class="market-card"></div>
                </div>
            </section>

            <!-- Section: Interest Rates & Economic Calendar -->
            <section class="mb-8 grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-1">
                    <h2 class="text-2xl font-semibold mb-4 border-l-4 border-purple-500 pl-3">Key Interest Rates</h2>
                    <div class="grid grid-cols-1 gap-6">
                        <div id="rbi-rate" class="market-card"></div>
                        <div id="fed-rate" class="market-card"></div>
                    </div>
                </div>
                <div class="lg:col-span-2">
                     <h2 class="text-2xl font-semibold mb-4 border-l-4 border-red-500 pl-3">Economic Calendar</h2>
                     <div class="tradingview-widget-container">
                        <div class="tradingview-widget-container__widget"></div>
                        <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-events.js" async>
                        {
                            "colorTheme": "dark",
                            "isTransparent": false,
                            "width": "100%",
                            "height": "400",
                            "locale": "in",
                            "importanceFilter": "0,1"
                        }
                        </script>
                    </div>
                </div>
            </section>
        </main>

        <!-- Footer -->
        <footer class="text-center mt-10 pt-6 border-t" style="border-color: var(--section-border);">
            <p class="text-sm label-text">Data is sourced from public APIs and simulated for educational purposes only.</p>
            <p class="text-xs mt-1 label-text">Built and hosted by Devdrshn, a student of markets and machine learning from IIT. Not financial advice. Last updated: <span id="last-updated"></span></p>
        </footer>
    </div>

    <!-- AI Analysis Modal -->
    <div id="analysis-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">✨ AI Market Briefing</h2>
                <button id="close-modal-btn" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>
            <div id="analysis-result" class="space-y-4"></div>
        </div>
    </div>

    <script>
        // --- SCRIPT START --- //

        let marketData = {};

        document.addEventListener('DOMContentLoaded', () => {
            initializeTheme();
            lucide.createIcons(); // Initialize icons
            
            fetchAllData();
            getMarketFlowsData(); // Fetch this once
            setInterval(fetchAllData, 60000);

            const modal = document.getElementById('analysis-modal');
            const generateBtn = document.getElementById('generate-briefing-btn');
            const closeModalBtn = document.getElementById('close-modal-btn');
            const themeToggle = document.getElementById('theme-toggle');

            generateBtn.addEventListener('click', getMarketAnalysis);
            closeModalBtn.addEventListener('click', () => modal.classList.remove('visible'));
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.classList.remove('visible');
            });
            themeToggle.addEventListener('click', toggleTheme);
        });

        function fetchAllData() {
            console.log("Fetching all market data...");
            renderLoadingState();
            const dataPromises = [
                getIndianIndicesData(),
                getGlobalMarketsData(),
                getCommoditiesData(),
                getInterestRatesData()
            ];
            Promise.allSettled(dataPromises).then(() => {
                console.log("All data processing finished.");
                updateTimestamp();
            });
        }
        
        function renderLoadingState() {
            const cardIds = [
                'nifty-50', 'sensex', 'gift-nifty', 'india-vix', 
                'sp-500', 'us-futures', 'dow-jones', 'ftse-100', 'nikkei-225', 'hang-seng',
                'brent-oil', 'wti-oil', 'gold', 
                'rbi-rate', 'fed-rate', 'fii-dii-data'
            ];
            cardIds.forEach(id => {
                const cardElement = document.getElementById(id);
                if(cardElement && !cardElement.hasChildNodes()) {
                    cardElement.innerHTML = `<div class="flex items-center justify-center h-full"><div class="loader"></div></div>`;
                }
            });
        }

        function renderCard(elementId, data) {
            const cardElement = document.getElementById(elementId);
            if (!cardElement) return;
            const isPositive = data.change >= 0;
            const changeClass = isPositive ? 'text-positive' : 'text-negative';
            const sign = isPositive ? '+' : '';
            cardElement.innerHTML = `
                <div><h3 class="text-lg font-semibold">${data.title}</h3></div>
                <div class="text-right mt-4">
                    <p class="text-2xl md:text-3xl font-bold">${data.price.toFixed(2)}</p>
                    <p class="text-md font-medium ${changeClass}">
                        <span>${sign}${data.change.toFixed(2)}</span>
                        <span>(${sign}${data.changePercent.toFixed(2)}%)</span>
                    </p>
                </div>`;
            marketData[elementId] = data;
        }
        
        function renderStaticCard(elementId, data) {
            const cardElement = document.getElementById(elementId);
            if (!cardElement) return;
            cardElement.innerHTML = `
                <div>
                    <h3 class="text-lg font-semibold">${data.title}</h3>
                    <p class="label-text mt-1">${data.note}</p>
                </div>
                <div class="text-right mt-4">
                    <p class="text-3xl font-bold">${data.value}</p>
                </div>`;
            marketData[elementId] = data;
        }

        async function getIndianIndicesData() {
            const niftyPrice = 23500 + (Math.random() * 200 - 100);
            const niftyChange = Math.random() * 150 - 75;
            renderCard('nifty-50', { title: 'Nifty 50', price: niftyPrice, change: niftyChange, changePercent: (niftyChange / (niftyPrice - niftyChange)) * 100 });
            
            const sensexPrice = 77200 + (Math.random() * 500 - 250);
            const sensexChange = Math.random() * 400 - 200;
            renderCard('sensex', { title: 'Sensex', price: sensexPrice, change: sensexChange, changePercent: (sensexChange / (sensexPrice - sensexChange)) * 100 });
            
            const giftNiftyPrice = niftyPrice + (Math.random() * 50 - 25);
            const giftNiftyChange = niftyChange + (Math.random() * 20 - 10);
            renderCard('gift-nifty', { title: 'GIFT Nifty', price: giftNiftyPrice, change: giftNiftyChange, changePercent: (giftNiftyChange / (giftNiftyPrice - giftNiftyChange)) * 100 });

            const vixPrice = 14 + (Math.random() * 4 - 2);
            const vixChange = Math.random() * 1 - 0.5;
            renderCard('india-vix', { title: 'India VIX', price: vixPrice, change: vixChange, changePercent: (vixChange / (vixPrice - vixChange)) * 100 });
        }

        async function getGlobalMarketsData() {
            const spPrice = 5450 + (Math.random() * 50 - 25);
            const spChange = Math.random() * 40 - 20;
            renderCard('sp-500', { title: 'S&P 500', price: spPrice, change: spChange, changePercent: (spChange / (spPrice - spChange)) * 100 });
            
            const futuresPrice = spPrice + (Math.random() * 10 - 5);
            const futuresChange = spChange + (Math.random() * 5 - 2.5);
            renderCard('us-futures', { title: 'US Futures (S&P)', price: futuresPrice, change: futuresChange, changePercent: (futuresChange / (futuresPrice - futuresChange)) * 100 });

            const dowPrice = 39000 + (Math.random() * 400 - 200);
            const dowChange = Math.random() * 300 - 150;
            renderCard('dow-jones', { title: 'Dow Jones', price: dowPrice, change: dowChange, changePercent: (dowChange / (dowPrice - dowChange)) * 100 });

            const ftsePrice = 8200 + (Math.random() * 80 - 40);
            const ftseChange = Math.random() * 60 - 30;
            renderCard('ftse-100', { title: 'FTSE 100', price: ftsePrice, change: ftseChange, changePercent: (ftseChange / (ftsePrice - ftseChange)) * 100 });

            const nikkeiPrice = 38500 + (Math.random() * 500 - 250);
            const nikkeiChange = Math.random() * 400 - 200;
            renderCard('nikkei-225', { title: 'Nikkei 225', price: nikkeiPrice, change: nikkeiChange, changePercent: (nikkeiChange / (nikkeiPrice - nikkeiChange)) * 100 });

            const hangSengPrice = 18000 + (Math.random() * 300 - 150);
            const hangSengChange = Math.random() * 250 - 125;
            renderCard('hang-seng', { title: 'Hang Seng', price: hangSengPrice, change: hangSengChange, changePercent: (hangSengChange / (hangSengPrice - hangSengChange)) * 100 });
        }

        async function getCommoditiesData() {
            const brentPrice = 85 + (Math.random() * 5 - 2.5);
            const brentChange = Math.random() * 2 - 1;
            renderCard('brent-oil', { title: 'Brent Crude Oil', price: brentPrice, change: brentChange, changePercent: (brentChange / (brentPrice - brentChange)) * 100 });

            const wtiPrice = 80 + (Math.random() * 5 - 2.5);
            const wtiChange = Math.random() * 2 - 1;
            renderCard('wti-oil', { title: 'WTI Crude Oil', price: wtiPrice, change: wtiChange, changePercent: (wtiChange / (wtiPrice - wtiChange)) * 100 });
            
            const goldPrice = 2330 + (Math.random() * 30 - 15);
            const goldChange = Math.random() * 20 - 10;
            renderCard('gold', { title: 'Gold (USD/oz)', price: goldPrice, change: goldChange, changePercent: (goldChange / (goldPrice - goldChange)) * 100 });
        }

        async function getInterestRatesData() {
            renderStaticCard('rbi-rate', { title: 'RBI Repo Rate', value: '6.50%', note: 'As of last MPC meeting' });
            renderStaticCard('fed-rate', { title: 'US Fed Funds Rate', value: '5.25-5.50%', note: 'As of last FOMC meeting' });
        }

        function getMarketFlowsData() {
            const fiiBuy = Math.floor(15000 + Math.random() * 5000);
            const fiiSell = Math.floor(15000 + Math.random() * 5000);
            const diiBuy = Math.floor(10000 + Math.random() * 4000);
            const diiSell = Math.floor(10000 + Math.random() * 4000);
            
            const fiiNet = fiiBuy - fiiSell;
            const diiNet = diiBuy - diiSell;

            // Store the data for the AI prompt (FIXED)
            marketData['fii-dii-data'] = {
                fiiNet: fiiNet,
                diiNet: diiNet,
                title: 'Market Flows'
            };

            const fiiClass = fiiNet >= 0 ? 'text-positive' : 'text-negative';
            const diiClass = diiNet >= 0 ? 'text-positive' : 'text-negative';
            
            const cardElement = document.getElementById('fii-dii-data');
            if (!cardElement) return;

            cardElement.innerHTML = `
                <h3 class="text-lg font-semibold mb-3">Market Flows (Yesterday)</h3>
                <div class="grid grid-cols-2 gap-4 text-center">
                    <div>
                        <p class="label-text">FII Net Flow</p>
                        <p class="text-xl font-bold ${fiiClass}">${(fiiNet / 1000).toFixed(2)}k Cr</p>
                    </div>
                    <div>
                        <p class="label-text">DII Net Flow</p>
                        <p class="text-xl font-bold ${diiClass}">${(diiNet / 1000).toFixed(2)}k Cr</p>
                    </div>
                </div>
            `;
        }

        function updateTimestamp() {
            const timestampEl = document.getElementById('last-updated');
            if (timestampEl) timestampEl.textContent = new Date().toLocaleTimeString('en-IN');
        }

        async function getMarketAnalysis() {
            const modal = document.getElementById('analysis-modal');
            const resultDiv = document.getElementById('analysis-result');
            const generateBtn = document.getElementById('generate-briefing-btn');

            modal.classList.add('visible');
            resultDiv.innerHTML = `<div class="flex items-center justify-center h-full"><div class="loader"></div></div>`;
            generateBtn.disabled = true;
            generateBtn.textContent = "✨ Generating...";

            const prompt = `
                As a senior financial analyst for the Indian market, provide a concise market briefing for a trader. 
                Use a professional yet easy-to-understand tone.
                Based on the following latest data points, summarize the current market sentiment, highlight key movers, and suggest what to watch out for.

                Current Data:
                - Nifty 50: ${marketData['nifty-50'].price.toFixed(2)} (${marketData['nifty-50'].change > 0 ? '+' : ''}${marketData['nifty-50'].changePercent.toFixed(2)}%)
                - India VIX: ${marketData['india-vix'].price.toFixed(2)}
                - S&P 500: ${marketData['sp-500'].price.toFixed(2)}
                - Brent Crude Oil: $${marketData['brent-oil'].price.toFixed(2)}
                - FII/DII Net Flow: FIIs were net ${marketData['fii-dii-data']?.fiiNet >= 0 ? 'buyers' : 'sellers'}, DIIs were net ${marketData['fii-dii-data']?.diiNet >= 0 ? 'buyers' : 'sellers'}.

                Structure your response in three short paragraphs: 
                1. Overall Market Sentiment (e.g., bullish, bearish, mixed, cautious).
                2. Key Drivers (mention Indian indices, VIX, global cues, and market flows).
                3. Outlook (a brief forward-looking statement).
            `;

            try {
                let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
                const payload = { contents: chatHistory };
                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error(`API Error: ${response.statusText}`);
                const result = await response.json();
                
                if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                    const text = result.candidates[0].content.parts[0].text;
                    resultDiv.innerHTML = text.replace(/\n/g, '<br>');
                } else {
                    throw new Error("Invalid response structure from API.");
                }

            } catch (error) {
                console.error("Error fetching from Gemini API:", error);
                resultDiv.innerHTML = `<p class="text-negative">Sorry, the AI briefing could not be generated. Please try again later.</p><p class="text-xs label-text mt-2">${error.message}</p>`;
            } finally {
                generateBtn.disabled = false;
                generateBtn.innerHTML = "✨ Generate AI Market Briefing";
            }
        }

        // --- THEME TOGGLE LOGIC --- //
        function initializeTheme() {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            if (savedTheme === 'light') {
                document.body.classList.add('light-mode');
            }
            updateThemeIcons(savedTheme);
            updateTradingViewWidgetsTheme(savedTheme);
        }

        function toggleTheme() {
            const isLight = document.body.classList.toggle('light-mode');
            const newTheme = isLight ? 'light' : 'dark';
            localStorage.setItem('theme', newTheme);
            updateThemeIcons(newTheme);
            // This is a bit of a hack for the widgets, as they need to be reloaded.
            // A full reload is the most reliable way to ensure they pick up the new theme.
            location.reload(); 
        }

        function updateThemeIcons(theme) {
            const lightIcon = document.querySelector('.light-icon');
            const darkIcon = document.querySelector('.dark-icon');
            if (theme === 'light') {
                lightIcon.classList.add('hidden');
                darkIcon.classList.remove('hidden');
            } else {
                lightIcon.classList.remove('hidden');
                darkIcon.classList.add('hidden');
            }
        }
        
        function updateTradingViewWidgetsTheme(theme) {
            // Find all TradingView widget scripts and update their theme
            document.querySelectorAll('script[src*="tradingview.com"]').forEach(script => {
                try {
                    const config = JSON.parse(script.innerHTML);
                    config.colorTheme = theme;
                    script.innerHTML = JSON.stringify(config);
                } catch(e) { console.error("Could not parse widget config", e); }
            });
        }
    </script>
</body>
</html>
